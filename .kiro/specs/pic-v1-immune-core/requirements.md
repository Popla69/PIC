# Requirements Document

## Introduction

PIC v1 (Popla Immune Core) is a production-grade defensive cybersecurity product designed to provide behavioral anomaly detection and automated response capabilities for Python applications. The system operates as an in-process instrumentation layer combined with a local analysis service, providing real-time threat detection, sandboxed validation, and safe remediation actions. Target users include SMBs, enterprise development teams, cloud providers, and research laboratories seeking to reduce behavior-based security breaches with low false-positive rates.

## Glossary

- **PIC**: Popla Immune Core - the complete defensive security system
- **CellAgent**: In-process instrumentation component that collects telemetry from the monitored application
- **SentinelBrain**: Local analysis service that evaluates behavioral anomalies and generates detection candidates
- **Effector**: Component responsible for executing safe remediation actions (allow, quarantine, block)
- **Sandbox Runner**: Isolated execution environment for testing detection candidates before promotion
- **Memory Bank**: Local SQLite database storing validated detection signatures and behavioral baselines
- **Admin Console**: User interface for reviewing alerts, managing decisions, and controlling system behavior
- **Telemetry Event**: Structured data record capturing application behavior (function calls, I/O operations, timing)
- **Detection Candidate**: Proposed anomaly detector generated by SentinelBrain requiring validation
- **Promotion**: Process of validating and activating a detection candidate into production use
- **Baseline Profile**: Statistical model of normal application behavior used for anomaly detection
- **Anomaly Score**: Numeric value indicating deviation from baseline behavior
- **False Positive (FP)**: Benign behavior incorrectly flagged as malicious
- **True Positive (TP)**: Malicious behavior correctly identified as a threat
- **Quarantine**: Remediation action that isolates suspicious behavior while allowing observation
- **Human-in-Loop**: Requirement for manual approval before critical automated actions

## Requirements

### Requirement 1

**User Story:** As a security engineer, I want to instrument Python applications with minimal overhead, so that I can collect behavioral telemetry without degrading application performance.

#### Acceptance Criteria

1. WHEN the CellAgent instruments a Python application, THE CellAgent SHALL introduce less than 5% median latency overhead under normal load
2. WHEN the CellAgent collects telemetry events, THE CellAgent SHALL sample events at a configurable rate to control resource consumption
3. WHEN the CellAgent binds to application code, THE CellAgent SHALL support decorator-based, import hook, and bytecode wrapper instrumentation methods
4. WHEN the CellAgent encounters an instrumentation error, THE CellAgent SHALL fail gracefully without crashing the monitored application
5. WHEN telemetry contains personally identifiable information, THE CellAgent SHALL redact PII before transmission to SentinelBrain

### Requirement 2

**User Story:** As a security analyst, I want the system to establish behavioral baselines automatically, so that I can detect anomalies without manual configuration.

#### Acceptance Criteria

1. WHEN the SentinelBrain receives telemetry events, THE SentinelBrain SHALL build a baseline profile using statistical methods over a configurable time window
2. WHEN the baseline profile is established, THE SentinelBrain SHALL compute anomaly scores for incoming events using L2 distance metrics
3. WHEN an anomaly score exceeds a configurable threshold, THE SentinelBrain SHALL generate a detection candidate
4. WHEN the baseline profile becomes stale, THE SentinelBrain SHALL trigger periodic retraining using recent telemetry data
5. WHEN multiple behavioral signals are available, THE SentinelBrain SHALL fuse signals from syscall frequency, I/O patterns, and timing data

### Requirement 3

**User Story:** As a DevOps engineer, I want detection candidates validated in a sandbox before deployment, so that I can prevent false positives from disrupting production.

#### Acceptance Criteria

1. WHEN a detection candidate is generated, THE Sandbox Runner SHALL execute the candidate against benign test scenarios in an isolated environment
2. WHEN the Sandbox Runner executes a candidate, THE Sandbox Runner SHALL enforce resource limits using cgroups and seccomp profiles
3. WHEN sandbox validation completes, THE Sandbox Runner SHALL return a verdict with sanitized execution traces
4. WHEN sandbox execution exceeds a timeout threshold, THE Sandbox Runner SHALL terminate the test and return a failure verdict
5. WHEN sandbox validation passes with zero false positives on benign data, THE detection candidate SHALL be eligible for promotion

### Requirement 4

**User Story:** As a security operator, I want human approval required for promoting detection candidates, so that I maintain control over automated defenses.

#### Acceptance Criteria

1. WHEN a detection candidate passes sandbox validation, THE Admin Console SHALL present the candidate for human review
2. WHEN a human operator reviews a candidate, THE Admin Console SHALL display explainability traces including event sequences and anomaly scores
3. WHEN a human operator approves a candidate, THE SentinelBrain SHALL promote the candidate to active detection status
4. WHEN a human operator rejects a candidate, THE SentinelBrain SHALL archive the candidate with rejection metadata
5. WHEN a promoted detector generates false positives, THE Admin Console SHALL provide a rollback mechanism to revert to the previous state

### Requirement 5

**User Story:** As an application owner, I want safe remediation actions that prevent damage, so that automated responses do not disrupt legitimate operations.

#### Acceptance Criteria

1. WHEN the Effector receives a detection alert, THE Effector SHALL execute one of three actions: allow, quarantine, or block
2. WHEN the Effector executes a quarantine action, THE Effector SHALL isolate the suspicious behavior while maintaining observability
3. WHEN the Effector executes a block action, THE Effector SHALL prevent the suspicious operation and return a safe stub value
4. WHEN the Effector encounters an error during remediation, THE Effector SHALL fail-safe to observe-only mode
5. WHEN the Effector applies rate limiting, THE Effector SHALL use a token bucket algorithm to prevent denial-of-service against PIC itself

### Requirement 6

**User Story:** As a compliance officer, I want all security decisions logged immutably, so that I can audit system behavior for regulatory requirements.

#### Acceptance Criteria

1. WHEN the system makes a detection or remediation decision, THE Audit Store SHALL record an immutable log entry with timestamp and decision metadata
2. WHEN telemetry events are logged, THE Audit Store SHALL redact personally identifiable information according to a configurable privacy policy
3. WHEN audit logs are written to disk, THE Audit Store SHALL encrypt logs at rest using industry-standard encryption
4. WHEN audit logs reach a retention threshold, THE Audit Store SHALL archive or delete logs according to the configured retention policy
5. WHEN forensic analysis is required, THE Admin Console SHALL export audit logs with cryptographic signatures for integrity verification

### Requirement 7

**User Story:** As a threat researcher, I want the system to store validated detection signatures, so that known threats can be blocked immediately without re-analysis.

#### Acceptance Criteria

1. WHEN a detection candidate is promoted, THE Memory Bank SHALL store a non-identifying hash signature of the threat pattern
2. WHEN the Memory Bank stores a signature, THE Memory Bank SHALL include metadata for provenance, timestamp, and expiration TTL
3. WHEN the Memory Bank receives a query for a signature, THE Memory Bank SHALL return matching entries with version information
4. WHEN a signature expires based on TTL, THE Memory Bank SHALL remove the signature and log the expiration event
5. WHEN an external signature is imported, THE Memory Bank SHALL validate cryptographic signatures before storage to prevent poisoning

### Requirement 8

**User Story:** As a system administrator, I want PIC components to recover gracefully from failures, so that security monitoring remains available during incidents.

#### Acceptance Criteria

1. WHEN the CellAgent process crashes, THE watchdog process SHALL detect the failure within 30 seconds and restart the agent
2. WHEN the CellAgent restarts, THE CellAgent SHALL restore state from the last checkpoint without data loss
3. WHEN the SentinelBrain becomes unavailable, THE CellAgent SHALL buffer telemetry events locally with backpressure control
4. WHEN the Sandbox Runner exhausts resources, THE Sandbox Runner SHALL apply circuit breaker logic to prevent cascading failures
5. WHEN the Admin Console loses connectivity, THE system SHALL continue autonomous operation in fail-safe observe mode

### Requirement 9

**User Story:** As a security architect, I want PIC to defend against tampering attempts, so that attackers cannot disable the security system.

#### Acceptance Criteria

1. WHEN the CellAgent binary is modified, THE watchdog process SHALL detect the integrity violation using hash verification
2. WHEN an integrity violation is detected, THE watchdog process SHALL alert administrators and attempt to restore the agent from a trusted source
3. WHEN the CellAgent loads modules, THE CellAgent SHALL verify code signatures for agent modules before execution
4. WHEN the CellAgent exposes IPC interfaces, THE CellAgent SHALL restrict access to authorized processes only
5. WHEN the CellAgent operates, THE CellAgent SHALL run with minimal privileges required for instrumentation

### Requirement 10

**User Story:** As a development team lead, I want comprehensive testing and CI/CD integration, so that I can deploy PIC with confidence in production environments.

#### Acceptance Criteria

1. WHEN code is committed to the repository, THE CI pipeline SHALL execute unit tests, integration tests, and security scans automatically
2. WHEN the CI pipeline runs security scans, THE CI pipeline SHALL fail builds containing dependencies with critical CVE vulnerabilities
3. WHEN the CI pipeline completes successfully, THE CI pipeline SHALL generate a Software Bill of Materials in CycloneDX format
4. WHEN release artifacts are built, THE CI pipeline SHALL sign container images and packages cryptographically
5. WHEN acceptance tests run, THE system SHALL achieve false positive rate ≤ 5%, true positive rate ≥ 75%, and latency overhead ≤ 5%

### Requirement 11

**User Story:** As a cloud operator, I want PIC packaged for easy deployment, so that I can integrate it into containerized and VM-based environments.

#### Acceptance Criteria

1. WHEN PIC is distributed, THE packaging system SHALL provide both a pip package and a container image
2. WHEN the container image is built, THE build process SHALL use multi-stage builds with minimal base images
3. WHEN PIC is installed, THE installation process SHALL verify prerequisites including Python version and required system capabilities
4. WHEN PIC is deployed, THE deployment documentation SHALL specify required ports, RBAC permissions, and resource limits
5. WHEN PIC packages are published, THE distribution system SHALL include installation checksums and signature verification instructions

### Requirement 12

**User Story:** As a product manager, I want clear documentation and demo materials, so that potential users can evaluate PIC quickly.

#### Acceptance Criteria

1. WHEN a user accesses PIC documentation, THE documentation SHALL include a 90-second overview with ASCII architecture diagram
2. WHEN a user runs the demo script, THE demo SHALL complete in under 5 minutes using docker-compose or local Python
3. WHEN the demo executes, THE demo SHALL demonstrate detection of simulated threats with visible metrics and behavioral logs
4. WHEN marketing materials are prepared, THE materials SHALL include a one-slide investor summary with value proposition
5. WHEN users evaluate PIC, THE documentation SHALL provide sample datasets for testing detection capabilities

### Requirement 13

**User Story:** As a security researcher, I want PIC to handle polymorphic threats, so that attackers cannot trivially evade detection through code variations.

#### Acceptance Criteria

1. WHEN the SentinelBrain detects behavioral patterns, THE SentinelBrain SHALL use ensemble detection methods combining multiple signal types
2. WHEN polymorphic variants of known threats appear, THE SentinelBrain SHALL detect behavioral similarities despite code differences
3. WHEN the SentinelBrain generates detection candidates, THE mutation engine SHALL create variants for robust testing
4. WHEN red-team exercises introduce polymorphic attacks, THE system SHALL maintain detection rate above 70% for mid-tier threats
5. WHEN adaptive countermeasures are observed, THE system SHALL trigger periodic retraining of detection models

### Requirement 14

**User Story:** As a legal counsel, I want PIC to comply with data privacy regulations, so that deployment does not create legal liability.

#### Acceptance Criteria

1. WHEN PIC collects telemetry data, THE system SHALL implement data minimization by storing only metadata and hashed signatures
2. WHEN users deploy PIC, THE system SHALL provide explicit consent and opt-in templates for data collection
3. WHEN PIC is distributed internationally, THE documentation SHALL include export compliance notes and legal review requirements
4. WHEN customer data is processed, THE system SHALL provide configurable privacy policies for different regulatory jurisdictions
5. WHEN legal review is required, THE release process SHALL include a legal sign-off checklist before production deployment

### Requirement 15

**User Story:** As a performance engineer, I want PIC to handle high-throughput scenarios, so that the system scales with application load.

#### Acceptance Criteria

1. WHEN the CellAgent receives high-rate telemetry events, THE CellAgent SHALL apply adaptive sampling to maintain performance targets
2. WHEN the SentinelBrain processes event floods, THE SentinelBrain SHALL use prioritized queues to handle critical events first
3. WHEN resource consumption exceeds thresholds, THE system SHALL apply backpressure to prevent memory exhaustion
4. WHEN stress tests simulate sustained load, THE system SHALL maintain stable operation without memory leaks over 24-hour runs
5. WHEN sandbox validation runs concurrently, THE Sandbox Runner SHALL enforce per-sandbox resource caps to prevent resource starvation

### Requirement 16

**User Story:** As a data scientist, I want precise metric definitions and measurement methods, so that I can validate system performance objectively.

#### Acceptance Criteria

1. WHEN false positive rate is calculated, THE system SHALL compute FPR as (number of benign sessions flagged / total benign sessions tested) measured on 10,000 held-out benign sessions
2. WHEN true positive rate is calculated, THE system SHALL compute TPR as (number of malicious sessions detected / total malicious sessions tested) measured on labeled test datasets
3. WHEN latency overhead is measured, THE system SHALL report median, P95, and P99 latency percentiles under a defined baseline load profile
4. WHEN baseline profiles are established, THE system SHALL require minimum 50 traces OR 24 hours of traffic before enabling enforcement mode
5. WHEN anomaly thresholds are computed, THE system SHALL use mean distance plus 3 standard deviations as the default L2 threshold

### Requirement 17

**User Story:** As a system integrator, I want well-defined telemetry schemas and default configurations, so that I can deploy PIC with predictable behavior.

#### Acceptance Criteria

1. WHEN telemetry events are generated, THE CellAgent SHALL format events as JSON with fields: timestamp, process_id, thread_id, function_name, args_metadata, duration_ms, resource_tags, and redaction_hashes
2. WHEN the CellAgent samples telemetry, THE CellAgent SHALL use a default sampling rate of 1 event per 10 invocations (configurable)
3. WHEN the SentinelBrain establishes baselines, THE SentinelBrain SHALL use a default window of 24 to 72 hours with minimum 50 traces
4. WHEN the Sandbox Runner executes tests, THE Sandbox Runner SHALL enforce a default timeout of 2 seconds (configurable)
5. WHEN rate limiting is applied, THE Effector SHALL use token bucket parameters: refill rate 500 tokens/second, bucket size 2000 tokens

### Requirement 18

**User Story:** As a security administrator, I want authentication and role-based access control, so that only authorized personnel can manage PIC.

#### Acceptance Criteria

1. WHEN users access the Admin Console, THE Admin Console SHALL authenticate users via OAuth2, OIDC, or SAML protocols
2. WHEN users are assigned roles, THE system SHALL support three role levels: viewer (read-only), operator (approve/reject), and admin (full control)
3. WHEN the CellAgent communicates with SentinelBrain, THE communication channel SHALL use mutual TLS for authentication and encryption
4. WHEN API access is requested, THE system SHALL validate signed tokens with expiration and scope verification
5. WHEN audit logs are written, THE Audit Store SHALL sign each entry using HMAC-SHA256 with timestamp to ensure write-once-read-many integrity

### Requirement 19

**User Story:** As a cryptographic operations manager, I want secure key management and trust bootstrapping, so that agent integrity verification is trustworthy.

#### Acceptance Criteria

1. WHEN agent binaries are signed, THE build system SHALL use cryptographic keys stored in a Key Management Service or Hardware Security Module
2. WHEN cryptographic keys are rotated, THE system SHALL support key rotation every 90 days with backward compatibility for verification
3. WHEN the watchdog verifies agent integrity, THE watchdog SHALL compute SHA-256 hashes and compare against signed manifests
4. WHEN customers deploy PIC, THE system SHALL support customer-provided KMS integration or managed keystore options
5. WHEN key material is accessed, THE system SHALL log all key access events to the Audit Store with principal identity

### Requirement 20

**User Story:** As an incident responder, I want clear incident response procedures and forensic capabilities, so that I can investigate security events effectively.

#### Acceptance Criteria

1. WHEN a true positive detection occurs, THE Admin Console SHALL provide a runbook with investigation steps and recommended actions
2. WHEN a false positive is identified, THE Admin Console SHALL provide a rollback procedure to revert the detection and update baselines
3. WHEN forensic analysis is required, THE system SHALL export complete event traces, anomaly scores, and decision metadata in JSON format
4. WHEN enterprise SLAs apply, THE system SHALL alert operators within 30 minutes of high-severity detections via configured channels
5. WHEN operators acknowledge alerts, THE Audit Store SHALL record acknowledgment timestamp and operator identity

### Requirement 21

**User Story:** As a machine learning engineer, I want well-defined training and test datasets, so that I can validate detection models reproducibly.

#### Acceptance Criteria

1. WHEN acceptance tests execute, THE test harness SHALL use a golden benign dataset containing 10,000 labeled sessions
2. WHEN detection capabilities are validated, THE test harness SHALL use a golden malicious dataset containing 2,000 labeled mid-tier threat sessions
3. WHEN polymorphic threat detection is tested, THE test harness SHALL use a variant dataset containing 2,000 polymorphic attack sessions
4. WHEN synthetic data is generated, THE data generator SHALL use deterministic seeds for reproducible test scenarios
5. WHEN datasets are labeled, THE labeling guidelines SHALL specify session boundaries, threat categories, and ground-truth annotations

### Requirement 22

**User Story:** As a privacy officer, I want configurable data retention and residency controls, so that PIC complies with regional data protection regulations.

#### Acceptance Criteria

1. WHEN telemetry metadata is stored, THE Memory Bank SHALL retain metadata for 90 days by default (configurable)
2. WHEN detailed execution traces are stored, THE Audit Store SHALL retain traces for 30 days by default (configurable)
3. WHEN local-only mode is enabled, THE system SHALL prevent all telemetry from leaving the host system
4. WHEN data residency requirements apply, THE system SHALL support configuration to restrict data storage to specific geographic regions
5. WHEN privacy impact assessments are required, THE documentation SHALL provide Data Protection Impact Assessment templates

### Requirement 23

**User Story:** As a DevOps engineer, I want observability and monitoring integrations, so that I can track PIC health in my existing monitoring infrastructure.

#### Acceptance Criteria

1. WHEN Prometheus scrapes metrics, THE system SHALL expose endpoints with metrics: event_rate, avg_latency, fpr_estimate, detector_count, sandbox_queue_length, watchdog_status
2. WHEN alert conditions are met, THE system SHALL send notifications via PagerDuty, Slack, or email integrations
3. WHEN performance regressions occur, THE CI pipeline SHALL compare current metrics against baseline artifacts and fail on threshold violations
4. WHEN the system operates, THE Admin Console SHALL display real-time dashboards showing detection rates, latency, and resource utilization
5. WHEN long-running tests execute, THE test harness SHALL export performance metrics as CSV artifacts for trend analysis

### Requirement 24

**User Story:** As a release manager, I want automated canary deployment with health checks, so that I can roll out updates safely with automatic rollback.

#### Acceptance Criteria

1. WHEN a new version is deployed, THE deployment system SHALL follow a canary progression: 1% → 5% → 25% → 100% of traffic
2. WHEN canary health checks run, THE system SHALL verify that false positive rate remains within 2x baseline threshold
3. WHEN canary health checks fail, THE deployment system SHALL automatically roll back to the previous version
4. WHEN rollback occurs, THE system SHALL restore configuration snapshots with zero data loss
5. WHEN canary stages complete successfully, THE deployment system SHALL require manual approval before proceeding to the next stage

### Requirement 25

**User Story:** As a supply chain security officer, I want dependency management and vulnerability scanning, so that PIC does not introduce vulnerable dependencies.

#### Acceptance Criteria

1. WHEN dependencies are specified, THE project SHALL pin all dependencies with cryptographic hashes in requirements.txt
2. WHEN the CI pipeline builds artifacts, THE CI pipeline SHALL generate a Software Bill of Materials in CycloneDX JSON format
3. WHEN the CI pipeline runs security scans, THE CI pipeline SHALL execute Dependabot and Snyk scans for known vulnerabilities
4. WHEN critical vulnerabilities are detected, THE CI pipeline SHALL fail the build and block artifact publication
5. WHEN container images are published, THE build system SHALL sign images using Cosign and pip packages using GPG signatures

### Requirement 26

**User Story:** As a chaos engineer, I want resilience testing scenarios, so that I can verify PIC handles failures gracefully.

#### Acceptance Criteria

1. WHEN the watchdog process fails, THE chaos test SHALL inject watchdog failure and verify agent fallback to observe-only mode
2. WHEN network partitions occur, THE chaos test SHALL simulate network isolation and verify local buffering with backpressure
3. WHEN sandbox resources are exhausted, THE chaos test SHALL create resource contention and verify circuit breaker activation
4. WHEN long-running stability tests execute, THE test harness SHALL run 72-hour tests measuring memory growth and leak detection
5. WHEN chaos tests complete, THE test report SHALL document recovery times and failure modes for each scenario

### Requirement 27

**User Story:** As a legal advisor, I want licensing and compliance documentation, so that PIC can be distributed legally across jurisdictions.

#### Acceptance Criteria

1. WHEN PIC is distributed, THE project SHALL include an End User License Agreement template requiring legal counsel review
2. WHEN telemetry collection is enabled, THE system SHALL present an opt-in consent dialog with clear privacy policy disclosure
3. WHEN PIC is exported internationally, THE documentation SHALL include export control compliance notes for cryptographic components
4. WHEN commercial deployment occurs, THE project SHALL provide a dual licensing model: Apache-2.0 for research, commercial license for enterprise
5. WHEN legal review is required, THE release checklist SHALL include sign-off from legal counsel before production distribution

### Requirement 28

**User Story:** As a customer success manager, I want support tiers and operational documentation, so that customers can deploy and maintain PIC successfully.

#### Acceptance Criteria

1. WHEN customers access documentation, THE documentation SHALL include quickstart guide, troubleshooting guide, incident response playbook, upgrade guide, and security hardening guide
2. WHEN support requests are submitted, THE support system SHALL define response time SLAs: 4 hours for critical, 24 hours for high, 72 hours for normal
3. WHEN customers deploy PIC, THE documentation SHALL provide recommended pricing model: per-host annual license plus premium support subscription
4. WHEN operational issues occur, THE troubleshooting guide SHALL include common failure modes, diagnostic commands, and resolution steps
5. WHEN upgrades are performed, THE upgrade guide SHALL document backup procedures, compatibility matrices, and rollback instructions
